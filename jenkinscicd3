pipeline {
agent any
stages {
stage("Clear Workspace"){
steps {
sh 'rm -rvf t*'
}
}
stage("Checkout") {
steps {
sh 'git clone https://github.com/3-tier-cicd/jenkinscicd3.git'
}
}
stage('GCP Auth') {
steps {
withCredentials([usernameColonPassword(credentialsId: 'GCP_PROJECT', variable: 'GCP_PROJECT'), file(credentialsId: 'GCP_CREDENTIALS', variable: 'GCP_CREDENTIALS')]) {
sh 'gcloud auth activate-service-account --key-file=$GCP_CREDENTIALS'
}
}
}
stage("Docker pull") {
steps {
withCredentials([usernameColonPassword(credentialsId: 'c53cd2b98f24467e1512bbbb1d751d64b75c3477e4f74cca4e9fa565b2e7d6d9', variable: 'Docker_credentials')]) {
sh "docker login -u charyy -p 123456789"
sh 'docker pull charyy/cassandradb:taga'

}
}
}
stage("Docker tag") {
steps {
sh 'docker tag charyy/cassandradb:taga gcr.io/tarak-408506/cassandradb:taga'
}
}
stage("Docker push") {
steps {
sh 'gcloud auth configure-docker'
sh 'docker push gcr.io/tarak-408506/cassandra:taga'
}
}
stage("cluster create") {
steps {
sh 'gcloud container clusters create cassandradb-cluster --num-nodes 3 --location=asia-south1-b'
}
}
stage("Create & expose deploy") {
steps {
sh 'kubectl create deployment cassandradb --image=gcr.io/tarak-408506/cassandradb:taga'
sh 'kubectl expose deployment cassandradb --type=LoadBalancer --port 80 --target-port 27017'
}
}
}
}
